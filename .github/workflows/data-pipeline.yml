name: Data Pipeline

on:
  schedule:
    - cron: '0 21 * * *'  # 5am SGT
    - cron: '0 9 * * *'    # 5pm SGT
  workflow_dispatch:

env:
  POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
  POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  ohlcv_pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          pip install --upgrade pip
          pip install requests pandas numpy psycopg2-binary "sqlalchemy<2" tenacity apache-airflow==2.8.0
      - name: Run OHLCV Pipeline
        run: |
          cd scripts
          python run_ohlcv_pipeline.py
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        continue-on-error: false

  news_pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          pip install --upgrade pip
          pip install requests pandas psycopg2-binary "sqlalchemy<2" tenacity openai python-dotenv
      - name: Run News Pipeline (pgvector)
        run: |
          cd scripts
          python run_news_pipeline_pgvector.py
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: false

  # Run screener daily after data pipelines (calls Vercel app API)
  # Run screener daily after data pipelines (calls Vercel app API)
  screener_run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [ohlcv_pipeline, news_pipeline]
    if: always() && (needs.ohlcv_pipeline.result == 'success' && needs.news_pipeline.result == 'success')
    continue-on-error: true
    steps:
      - name: Trigger daily screener
        run: |
          RUN_DATE=$(date -u +%Y-%m-%d)
          echo "Triggering screener for run_date=$RUN_DATE"
          HTTP=$(curl -s -o /tmp/screener.json -w "%{http_code}" -X POST \
            "${{ secrets.VERCEL_APP_URL }}/api/screen/run" \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -d "{\"runDate\": \"$RUN_DATE\"}")
          echo "Response HTTP $HTTP"
          cat /tmp/screener.json
          if [ "$HTTP" != "200" ]; then 
            echo "Screener API returned $HTTP. Ignoring failure for decoupled workflow."
            exit 1
          fi
        env:
          VERCEL_APP_URL: ${{ secrets.VERCEL_APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
